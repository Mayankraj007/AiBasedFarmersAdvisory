const { GoogleGenerativeAI } = require("@google/generative-ai");
require("dotenv").config();

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

const generateAdvisory = async (cropType, cropName, activity, weather) => {
    const prompt = `
        Generate a **short and clear** agricultural advisory (2-3 lines per section) tailored to the crop type, considering local weather, soil conditions, and common farming practices.

        ğŸ“Œ Inputs:
        - Crop Type: ${cropType}
        - Crop Name: ${cropName}
        - Activity: ${activity}
        - **Weather Forecast (Next 5 Days):**  
        ${JSON.stringify(weather, null, 2)}

        ğŸ“¢ Output Format:  
        - ğŸ“… Date-wise Weather Summary (Max 2 lines per day)
        - âš ï¸ Risks & Warnings (Highlight potential threats in max 2 lines for the given crop)
        - ğŸŒ± Decision (Proceed/Delay) & Why? (Max 2 lines)
        - ğŸšœ Farmer Actions (Max 3 points, 1 line each)

        ğŸ”¹ Example Output:  
        ---  
        ğŸ“¢ Advisory for Wheat (Delay Sowing)  
        
        ğŸ“… Weather Forecast:  
        - ğŸ—“ 28 Mar: ğŸŒ§ Heavy rain (50mm), ğŸŒ¡ 18Â°C â†’ âš ï¸ High waterlogging risk for wheat.  
        - ğŸ—“ 29 Mar: â˜ï¸ Cloudy, ğŸŒ¡ 20Â°C â†’ âš ï¸ Fungal risk due to high humidity.  
        - ğŸ—“ 30 Mar:ğŸŒ Sunny, ğŸŒ¡ 25Â°C â†’ âœ… Good for drying fields.

        #### âš ï¸ Risks & Warnings:  
        - Waterlogging risk from rain on 28 Mar. Wheat is highly vulnerable to standing water.  
        - Humidity may encourage fungal growth, especially in early-stage crops.

        **ğŸŒ± Delay Sowing:  
        Wheat requires dry soil to avoid waterlogging. Wait until the soil is well-drained.**

        ğŸšœ Farmer Actions:  
        âœ… Delay sowing for 3 days.  
        âœ… Improve drainage around the field.  
        âœ… Monitor fungal symptoms and apply fungicide if needed.

        ----

        Now, generate a **similar, concise advisory** for the given crop type and weather, ensuring the Risks & Warnings section is always included if applicable and tailored to the crop.
    `;

    try {
        const result = await model.generateContent(prompt);
        return result.response.text();
    } catch (err) {
        console.error("Gemini API Error:", err);
        return "Advisory generation failed.";
    }
};

module.exports = { generateAdvisory };
